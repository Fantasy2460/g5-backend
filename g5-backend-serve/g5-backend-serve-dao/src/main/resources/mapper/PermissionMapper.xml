<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.g5backend.serve.dao.PermissionDao">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.bosssoft.rbac.entity.po.Permission">
        <id column="id" property="id"/>
        <result column="path" property="path"/>
        <result column="component" property="component"/>
        <result column="title" property="title"/>
        <result column="icon" property="icon"/>
        <result column="pid" property="pid"/>
        <result column="code" property="code"/>
        <result column="hidden" property="hidden"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="operator" property="operator"/>
        <result column="is_deleted" property="deleted"/>
    </resultMap>

    <select id="findPermissionListByUserId" resultType="com.bosssoft.rbac.entity.po.Permission">
        SELECT DISTINCT p.id, p.path, p.component, p.title, p.icon, p.code, p.pid
        FROM t_user AS u
                 LEFT JOIN t_user_role AS ur ON u.id = ur.u_id
                 LEFT JOIN t_role AS r on ur.r_id = r.id
                 LEFT JOIN t_role_permission AS rp on rp.r_id = r.id
                 LEFT JOIN t_permission AS p on rp.p_id = p.id
        WHERE u.id = #{userId}
          AND p.is_deleted = 0
        ORDER BY p.id ASC
    </select>

    <select id="findRolesByPermissionId" resultType="String" parameterType="Long">
        SELECT DISTINCT r.role_name
        FROM t_permission AS p
                 LEFT JOIN t_role_permission AS rp ON p.id = rp.p_id
                 LEFT JOIN t_role AS r ON r.id = rp.r_id
        WHERE p.id = #{permissionID}
          AND p.is_deleted = 0
    </select>

    <insert id="savePermissionRoles">
        INSERT INTO t_role_permission(p_id,r_id) values
        <foreach collection="roleIds" item="item" index="index" separator=",">
            (#{id},#{item})
        </foreach>
    </insert>

</mapper>
